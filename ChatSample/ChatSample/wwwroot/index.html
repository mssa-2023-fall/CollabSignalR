<!DOCTYPE html>
<html>

<head>
    <title>SignalR Simple Chat</title>
    <style type="text/css">
        .container {
            background-color: #99CCFF;
            border: thick solid #808080;
            padding: 20px;
            margin: 20px;
        }

        .emoji-reaction {
            display: inline-block;
            cursor: pointer;
        }

        .emoji-wrapper span {
            display: none;
        }

        .emoji-wrapper.shown span {
            display: inline-block;
            margin: 0 5px;
        }

        .plus-sign {
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            margin-left: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <input type="text" id="message" />
        <input type="button" id="sendmessage" value="Send" />
        <ul id="discussion"></ul>
    </div>
    <script type="text/javascript" src="lib/signalr.min.js"></script>
    <script type="text/javascript">
        // Wait for the document to fully load before running the script
        document.addEventListener('DOMContentLoaded', function () {

            // Get the message input box and store it in a variable
            var messageInput = document.getElementById('message');

            // Prompt the user to enter their name
            var name = prompt('Enter your name:', '');

            // Focus the message input box to make it ready for typing
            messageInput.focus();

            // Initialize a new SignalR connection to the server at the given URL
            var connection = new signalR.HubConnectionBuilder()
                .withUrl('/chat')
                .build();

            // Define how the client should respond when a "broadcastMessage" is received from the server
            connection.on('broadcastMessage', function (user, messageText, messageId) {

                // Store the username and the message text received from the server
                var encodedName = user;
                var encodedMsg = messageText;

                // Create a new list item element to display the message
                var liElement = document.createElement('li');

                // Set the inner content of the list item element with the username and message text
                liElement.innerHTML = '<strong>' + encodedName + '</strong>:&nbsp;&nbsp;' + encodedMsg;

                // Store the messageId on the list item for later use
                liElement.setAttribute('data-message-id', messageId);

                // Create a new span element for the "+" sign (to show emoji reactions when clicked)
                var plusSign = document.createElement('span');
                plusSign.textContent = '+';
                plusSign.className = 'plus-sign';

                // Create a container for the emoji reactions
                var emojiWrapper = document.createElement('div');
                emojiWrapper.className = 'emoji-wrapper';

                // Define the emoji reactions available
                var emojis = ['&#128512;', '&#127789;', '&#128578;'];

                // For each emoji, create a clickable element and add event listeners
                emojis.forEach(function (emojiCode) {
                    var emoji = document.createElement('span');
                    emoji.innerHTML = emojiCode;
                    emoji.className = 'emoji-reaction';

                    // When an emoji is clicked, send a reaction to the server
                    emoji.addEventListener('click', function () {
                        emojiWrapper.innerHTML = emojiCode;
                        connection.invoke('AddEmojiCount', name, emojiCode, messageId);
                        plusSign.style.display = 'none';
                    });
                    emojiWrapper.appendChild(emoji);
                });

                // Show emoji reactions when the "+" sign is clicked
                plusSign.addEventListener('click', function () {
                    emojiWrapper.classList.add('shown');
                });

                // Append the "+" sign and emoji wrapper to the list item
                liElement.appendChild(plusSign);
                liElement.appendChild(emojiWrapper);

                // Append the list item to the "discussion" list
                document.getElementById('discussion').appendChild(liElement);
            });

            // Define how the client should respond when an "updateReactions" message is received from the server
            connection.on('updateReactions', function (messageId, emoji, count) {

                // Find the list item associated with the given messageId
                var messageElement = document.querySelector('li[data-message-id="' + messageId + '"]');

                if (!messageElement) return;

                // Find the emoji reaction inside the list item
                var emojiElement = messageElement.querySelector('span.emoji-reaction:contains("' + emoji + '")');

                if (!emojiElement) {
                    // If the emoji reaction doesn't exist yet, create it
                    emojiElement = document.createElement('span');
                    emojiElement.innerHTML = emoji + " " + count;
                    emojiElement.className = 'emoji-reaction';

                    // Append the emoji reaction to the list item
                    var emojiWrapper = messageElement.querySelector('.emoji-wrapper');
                    emojiWrapper.appendChild(emojiElement);
                } else {
                    // If the emoji reaction already exists, update its count
                    emojiElement.innerHTML = emoji + " " + count;
                }
            });

            // Start the SignalR connection
            connection.start()
                .then(function () {
                    console.log('connection started');

                    // When the "Send" button is clicked, send the message to the server
                    document.getElementById('sendmessage').addEventListener('click', function (event) {
                        connection.invoke('SendMessage', name, messageInput.value);
                        messageInput.value = '';
                        messageInput.focus();
                        event.preventDefault();
                    });
                })
                .catch(error => {
                    console.error(error.message);
                });
        });
    </script>
</body>

</html>